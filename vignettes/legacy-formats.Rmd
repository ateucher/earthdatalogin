---
title: "Legacy data formats with cloud tools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Legacy data formats with cloud tools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Not all data formats which NASA EarthData makes available on cloud storage are provided in cloud-optimized or even VSI-compatible formats.  A stark example is HDF4. 
Here we illustrate how to work with these data formats while staying as close to the cloud-native workflow shown in other vignettes.

Aside: note that in many cases, these same data products may be available in cloud-native formats from other providers.  Particular to the example here, see the cloud-optimized [MODIS catalog on the Planetary Computer STAC](https://planetarycomputer.microsoft.com/dataset/group/modis).





```r
library(earthdatalogin)
```



```r
library(rstac)
library(gdalcubes)
library(spData)
#> The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
#> which was just loaded, will retire in October 2023.
#> Please refer to R-spatial evolution reports for details, especially
#> https://r-spatial.org/r/2023/05/15/evolution4.html.
#> It may be desirable to make the sf package available;
#> package maintainers should consider adding sf to Suggests:.
#> The sp package is now running under evolution status 2
#>      (status 2 uses the sf package in place of rgdal)
#> To access larger datasets in this package, install the spDataLarge package with: `install.packages('spDataLarge', repos='https://nowosad.github.io/drat/', type='source')`
library(sf)
#> Linking to GEOS 3.12.0, GDAL 3.7.1, PROJ 9.2.1; sf_use_s2() is TRUE
gdalcubes_options(parallel = TRUE) 
```


```r
CA <- spData::us_states |> dplyr::filter(NAME=="California")
bbox <- CA |> st_bbox()
start <- "2022-01-01"
end <- "2022-12-31"

items <- stac("https://cmr.earthdata.nasa.gov/stac/LPCLOUD") |> 
  stac_search(collections = "MOD13Q1.v061",
              bbox = c(bbox),
              datetime = paste(start,end, sep = "/")) |>
  post_request() |>
  items_fetch()
#>   |                                                                                                                                                                                             |=====================================================================================================================================================================================| 100%
```

HDF4 doesn't support cloud (range-request-based) access / VSI.
Instead, we download all matching assets with `earthdatalogin`
authentication:


```r
paths <- items$features |>
  purrr::map(list("assets", "data", "href")) |>
  purrr::map_chr(edl_download)
```

Rather than create an image collection using STAC metadata, we can use the recognized format and the local paths:


```r
col <- gdalcubes::create_image_collection(paths, format = "MxD13Q1")
```


```r
# Define whatever view you like!
v = cube_view(srs = "EPSG:4326",
              extent = list(t0 = as.character(start), 
                            t1 = as.character(end),
                            left = bbox[1], right = bbox[3],
                            top = bbox[4], bottom = bbox[2]),
              nx = 512, ny = 512, dt = "P1M")
```


```r
raster_cube(col, v) |> 
  select_bands("NDVI") |> 
  animate(col = viridisLite::mako, fps=2)
#> [1] "/tmp/Rtmp6fXY6c/file7f0ad2fd6f299.gif"
```



```r
library(tmap)
r <- 
  raster_cube(col, v) |> 
  select_bands("NDVI") |> 
  st_as_stars.cube()
#> Warning: ignoring unrecognized unit: NDVI

#> Warning: ignoring unrecognized unit: NDVI

tm_shape(r) + tm_raster("NDVI") +
  tm_shape(CA) + tm_borders()
#> Warning: col specification in tm_raster is ignored, since stars object contains a 3rd dimension, where its values are used to create facets
#> Variable(s) "NDVI" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.
```

![plot of chunk unnamed-chunk-8](figure/unnamed-chunk-8-1.png)


